{% load static %}
<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Wizard-v4</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">

    <link rel="stylesheet" type="text/css" href="{% static 'user/ch/css/opensans-font.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'user/ch/css/roboto-font.css' %}">
    <link rel="stylesheet" type="text/css"
        href="{% static 'user/ch/fonts/material-design-iconic-font/css/material-design-iconic-font.min.css' %}">

    <link rel="stylesheet" type="text/css" href="{% static 'user/ch/css/jquery-ui.min.css' %}">
    <link rel="stylesheet" href="{% static 'user/ch/css/style.css' %}" />

    <script
        src="https://www.paypal.com/sdk/js?client-id=ARsA1CrNglAhZB2jvaJF0rLNy2CXuAKo8T3jBQkutGC_4vl-7GHvbk_vpdxEROch8KMnVqGk1FUVmYir&currency=USD"></script>
</head>

<body>

    <div class="container">
        <div class="row">
            <div class="col-md-7">
                <div class="row">
                    <div class="col-md-12">
                        <div class="page-content">
                            <div class="wizard-v4-content">
                                <div class="wizard-form">
                                    <div class="wizard-header">
                                        <h3 class="heading" style="color: navy;"><b>C</b>heck <b>O</b>ut</h3>
                                        <p>Fill all form field to go next step</p>
                                    </div>
                                    <div class="form-register">
                                        <div id="form-total">
                                            <h3>
                                                <b>Address</b>
                                            </h3>
                                            <hr>
                                            <p><b>Name:</b>{{ order.full_name }}</p>
                                            <p><b>Address:</b>{{ order.address }}</p>
                                            <p>{{ order.city }}({{ order.pincode }}),{{ order.district }},{{ order.state }},{{ order.country }}</p>
                                            <p><b>Email:</b>{{ order.email }}</p>
                                            <p><b>Phone No:</b>{{ order.phone }}</p>
                                            {% if order.phone2 %}
                                            <p><b>Phone No (2):</b>{{ order.phone2 }}</p>
                                            {% endif %}
                                            {% if order.address2 %}
                                            <p>{{ order.address2 }}</p>
                                            {% endif %}
                                            {% if order.order_note %}
                                            <p><b>Note:</b>{{ order.order_note }}</p>
                                            {% endif %}
                                            <hr>
                                            <h3><b>Payment</b></h3>
                                            <hr>
                                            PAY PAL
                                            <br>
                                            <hr>
                                            <h3>
                                                <b>Product</b>
                                            </h3>
                                            <table class="table nowrap">
                                                <thead>
                                                    <tr>
                                                        <th class="table-plus datatable-nosort">images</th>
                                                        <th>Prodect_name</th>
                                                        <th>Quantity</th>
                                                        <th>Total</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for cart_item in cart_items %}
                                                    <tr>
                                                        <td class="table-plus">
                                                            <div class="name-avatar d-flex align-items-center">
                                                                <div class="avatar mr-2 flex-shrink-0">
                                                                    <img src="{{ cart_item.prodect.img1.url }}"
                                                                        class="border-radius-100 shadow" width="65px"
                                                                        height="65px" alt="">
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td>{{cart_item.prodect.prodectname}}</td>
                                                        <td>{{cart_item.quantity}}</td>
                                                        <td>{{cart_item.sub_total}}</td>
                                                    </tr>
                                                    {% endfor %}

                                                </tbody>
                                            </table>


                                        </div>
                                    </div>

                                    <!-- <div class="container">
                                        <div class="wizard-v4-content" style="width: 100%; display: flex; justify-content: center;">
                                            xfghgxhfghcgh
                                        </div>
                                    </div> -->
                                </div>
                            </div>


                        </div>

                    </div>
                </div>
            </div>

            <div class="col-md-"></div>
            <div class="col-md-5">
                <div class="row sticky-top">
                    <div class="wizard-v4-content">
                        <div class="col-md-12">
                            <div class="row">
                                <div class="col-md-6">
                                    <br>
                                    Total=
                                </div>
                                <div class="col-md-6">
                                    <br>
                                    {{total}}
                                </div>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-md-6">
                                    <br>
                                    tax=
                                </div>
                                <div class="col-md-6">
                                    <br>
                                    {{tax}}
                                </div>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-md-6">
                                    <br>
                                    Grand Total=
                                </div>
                                <div class="col-md-6">
                                    <br>
                                    {{grand_total}}
                                </div>
                            </div>
                            <hr>
                            <div id="paypal-button-container">

                            </div>

                        </div>




                    </div>

                </div>
            </div>

        </div>

        <script src="{% static 'user/ch/js/jquery-3.3.1.min.js' %}"></script>
        <script src="{% static 'user/ch/js/jquery.steps.js' %}"></script>
        <script src="{% static 'user/ch/js/jquery-ui.min.js' %}"></script>
        <script>
            $(function () {
                $("#form-total").steps({
                    // headerTag: "h2",
                    // bodyTag: "section",
                    // transitionEffect: "fade",
                    // enableAllSteps: true,
                    // autoFocus: true,
                    // transitionEffectSpeed: 500,
                    titleTemplate: '<div class="title">#title#</div>',
                    labels: {
                        previous: 'Back Step',
                        next: 'Next Step',
                        finish: 'Submit',
                        current: ''
                    },
                });
            });
        </script>
        <script>

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            


            var amount = "{{grand_total}}"
            var url = "{% url 'pay' %}"
            var csrftoken = getCookie('csrftoken');
            var orderID = "{{order.order_number}}"
            var payment_method = 'Paypal'
            var redirect_url = "{% url 'success' order.order_number %}"

            // Render the PayPal button into #paypal-button-container
            paypal.Buttons({

                // Set up the transaction
                createOrder: function (data, actions) {
                    return actions.order.create({
                        purchase_units: [{
                            amount: {
                                value: amount,
                            }
                        }]
                    });
                },

                // Finalize the transaction
                onApprove: function (data, actions) {
                    return actions.order.capture().then(function (details) {
                        // Successful capture! For demo purposes:
                        console.log(details);
                        sendData();
                        function sendData() {
                            fetch(url, {
                                method: 'POST',
                                headers: {
                                    "Content-type": "application/json",
                                    "x-CSRFToken": csrftoken,
                                },
                                body: JSON.stringify({
                                    orderID: orderID,
                                    transID: details.id,
                                    payment_method: payment_method,
                                    status: details.status,
                                }),
                            })
                            .then((response) => response.json())
                            .then((data) => {
                                window.location.href = redirect_url + '?order_number='+ data.order_number + '&payment_id='+data.transID;
                            });
                        }
                        // Replace the above to show a success message within this page, e.g.
                        // const element = document.getElementById('paypal-button-container');
                        // element.innerHTML = '';
                        // element.innerHTML = '<h3>Thank you for your payment!</h3>';
                        // Or go to another URL:  actions.redirect('thank_you.html');
                    });
                }


            }).render('#paypal-button-container');
        </script>
</body>

</html>